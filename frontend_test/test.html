<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CoE FETJU - Admin Login</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<style>
  body { font-family: 'Inter', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #e0f2fe; margin:0; }
  .container { background: white; padding: 30px; border-radius: 12px; width: 380px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
  h2 { text-align: center; color: #0c4a6e; margin-bottom: 20px; }
  input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
  button { width: 100%; padding: 12px; border: none; background: #0284c7; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; }
  button:disabled { background: #94a3b8; cursor: not-allowed; }
  pre { background: #0f172a; color: #f1f5f9; padding: 12px; border-radius: 8px; margin-top: 20px; max-height: 300px; overflow-y: auto; font-size: 13px; }
  .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="container">
  <h2>Admin Login</h2>
  <input type="email" id="email" placeholder="Email" value="dummyfirebase12@gmail.com">
  <input type="password" id="password" placeholder="Password" value="Admin@123">
  <button id="loginBtn"><span id="btnText">Sign In</span></button>
  <pre id="status">System ready. Enter credentials.</pre>
</div>

<script>
// ================= Firebase Config =================
const firebaseConfig = {
  apiKey: "AIzaSyAeihSJVvJ1PvJCn89G1AR49ZzKbgAc8go",
  authDomain: "coe-fetju.firebaseapp.com",
  projectId: "coe-fetju",
  storageBucket: "coe-fetju.appspot.com",
  messagingSenderId: "346865125555",
  appId: "1:346865125555:web:b6dbe6ab297016934048c6"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

// ================= DOM Elements =================
const loginBtn = document.getElementById('loginBtn');
const btnText = document.getElementById('btnText');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const status = document.getElementById('status');

// ================= Helper =================
function updateStatus(msg, success=false){
  status.textContent = msg;
  status.style.color = success ? "#10b981" : "#ef4444";
}

// ================= Login Function =================
loginBtn.onclick = async () => {
  const email = emailInput.value.trim();
  const password = passwordInput.value;

  // Only allow admin
  if(email !== "dummyfirebase12@gmail.com") {
    updateStatus("❌ Only admin login allowed!", false);
    return;
  }

  btnText.innerHTML = '<span class="spinner"></span> Authenticating...';
  loginBtn.disabled = true;
  updateStatus("Logging in with Firebase...");

  try {
    // 1️⃣ Firebase login
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    updateStatus("Firebase authentication successful ✔️", true);

    // 2️⃣ Get Firebase ID token
    const idToken = await userCredential.user.getIdToken();
    updateStatus("ID token obtained. Verifying in backend...", true);

    // 3️⃣ Send token to Apps Script backend
    const response = await fetch("https://script.google.com/macros/s/AKfycbwm27kxyZBB7o1iyV09tNNd5nxWnxIyjoMkuD2LLFAqQa6T7fYxcw2yFzblU4NfVJLY/exec", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "getProfile", token: idToken, requestId: "req_" + Date.now() })
    });

    if(!response.ok) throw new Error(`HTTP ${response.status}`);
    const result = await response.json();

    if(result.success){
      updateStatus("✅ Login successful!\nProfile:\n" + JSON.stringify(result.profile, null, 2), true);
    } else {
      updateStatus("❌ Backend error: " + result.error);
    }

  } catch(e){
    let msg = "Authentication failed.";
    if(e.code === 'auth/user-not-found') msg = "Admin not found in Firebase!";
    if(e.code === 'auth/wrong-password') msg = "Incorrect password!";
    updateStatus(msg + "\n" + e.message);
  } finally {
    btnText.textContent = 'Sign In';
    loginBtn.disabled = false;
  }
};
</script>

</body>
</html>
